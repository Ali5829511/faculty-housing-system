# دليل ميزة عداد التكرار التلقائي
## نظام إدارة المرور الجامعي - جامعة الإمام

---

## نظرة عامة

**عداد التكرار التلقائي (Visit Counter)** هو ميزة ذكية في نظام إدارة المرور الجامعي تقوم بتتبع عدد مرات دخول كل مركبة إلى الحرم الجامعي بشكل تلقائي، دون أي تدخل يدوي. هذه الميزة تعمل بالتكامل مع **Plate Recognizer API** لتوفير بيانات دقيقة وموثوقة عن حركة المركبات.

---

## كيف تعمل الميزة؟

### 1. التعرف التلقائي على اللوحات

عندما تمر مركبة عبر بوابات الجامعة المجهزة بكاميرات:

- **الكاميرا تلتقط صورة** للمركبة ولوحتها
- **النظام يرسل الصورة** إلى Plate Recognizer API
- **API يستخرج رقم اللوحة** (بالعربي والإنجليزي)
- **النظام يتحقق** من قاعدة البيانات:
  - إذا كانت المركبة **مسجلة مسبقاً**: يزيد العداد بمقدار 1
  - إذا كانت المركبة **جديدة**: يتم إنشاء سجل جديد بعداد = 1

### 2. التحديث التلقائي

```sql
-- مثال على كيفية تحديث العداد في قاعدة البيانات
UPDATE vehicles 
SET visitCount = visitCount + 1, 
    updatedAt = NOW() 
WHERE plateNumber = 'ABC1234';
```

كل مرة تدخل فيها المركبة، يتم:
- ✅ زيادة `visitCount` بمقدار 1
- ✅ تسجيل الزيارة في جدول `visits` مع التفاصيل الكاملة
- ✅ تحديث `updatedAt` لتتبع آخر زيارة
- ✅ حفظ صورة المركبة في S3

### 3. مصادر التحديث

يتم تحديث العداد من **3 مصادر**:

#### أ. Webhooks من Plate Recognizer (تلقائي)
```javascript
// عند استقبال webhook من Plate Recognizer
POST /trpc/plateRecognizer.webhook
{
  "data": {
    "results": [{
      "plate": "ABC1234",
      "score": 0.95,
      "vehicle": { ... }
    }]
  }
}
```

#### ب. معالجة الصور الدفعية (Batch Processing)
- رفع مجلد صور من صفحة "معالجة الصور"
- النظام يعالج كل صورة ويحدث العداد تلقائياً

#### ج. إدخال يدوي (من صفحة مركز البيانات)
- إضافة زيارة يدوياً من واجهة المستخدم
- العداد يتحدث تلقائياً

---

## فوائد الميزة

### 1. **تتبع دقيق للحركة**
- معرفة عدد مرات دخول كل مركبة بدقة 100%
- تحديد المركبات الأكثر تكراراً
- تحليل أنماط الحركة (يومي، أسبوعي، شهري)

### 2. **كشف الأنماط المشبوهة**
- تنبيه عند دخول مركبة أكثر من 5 مرات في يوم واحد
- تحديد المركبات التي تدخل في أوقات غير اعتيادية
- رصد المركبات غير المصرح لها

### 3. **تحسين الأمن**
- مراقبة المركبات المعلقة أو الموقوفة
- تتبع المركبات المطلوبة أمنياً
- إنشاء قوائم سوداء تلقائية

### 4. **تقارير وإحصائيات**
- تقرير "المركبات الأكثر تكراراً" (Top 10)
- رسم بياني لتوزيع الزيارات حسب الوقت
- تحليل أنماط الحركة حسب نوع المركبة

---

## كيفية الاستفادة من الميزة

### 1. عرض عداد التكرار

#### في صفحة "قاعدة بيانات المركبات"
```
| رقم اللوحة | المالك | النوع | عدد الزيارات | الحالة |
|-----------|--------|------|-------------|--------|
| ABC 1234  | أحمد   | طالب | 45          | نشط    |
| XYZ 5678  | محمد   | موظف | 120         | نشط    |
```

#### في صفحة "تقرير التكرار"
- **جدول المركبات الأكثر تكراراً**: Top 10 مركبات
- **رسم بياني حسب الساعة**: توزيع الزيارات خلال 24 ساعة
- **رسم بياني حسب اليوم**: توزيع الزيارات حسب أيام الأسبوع
- **رسم بياني للاتجاه**: تطور الزيارات خلال آخر 30 يوم

### 2. إنشاء تنبيهات ذكية

```javascript
// مثال: تنبيه للمركبات المتكررة بشكل غير طبيعي
if (vehicle.visitCount > 5 && lastVisitToday) {
  sendAlert({
    type: 'suspicious_activity',
    message: `المركبة ${vehicle.plateNumber} دخلت ${vehicle.visitCount} مرات اليوم`,
    severity: 'high'
  });
}
```

### 3. تحليل أنماط الحركة

#### أ. تحديد أوقات الذروة
```sql
SELECT 
  HOUR(timestamp) as hour,
  COUNT(*) as visit_count
FROM visits
GROUP BY HOUR(timestamp)
ORDER BY visit_count DESC;
```

#### ب. تحليل حسب نوع المستخدم
```sql
SELECT 
  v.ownerType,
  AVG(v.visitCount) as avg_visits,
  MAX(v.visitCount) as max_visits
FROM vehicles v
GROUP BY v.ownerType;
```

### 4. إنشاء قوائم ذكية

#### قائمة المركبات VIP (الأكثر تكراراً)
- المركبات التي دخلت أكثر من 100 مرة
- تلقائياً تحصل على تاج "VIP"
- أولوية في الدخول والخروج

#### قائمة المركبات المشبوهة
- المركبات التي دخلت أكثر من 5 مرات في يوم واحد
- المركبات التي تدخل في أوقات غير اعتيادية (بعد منتصف الليل)

---

## أمثلة عملية للاستخدام

### مثال 1: مراقبة مركبة طالب

**السيناريو**: طالب يدخل الجامعة يومياً

```
التاريخ        | الوقت  | نوع الزيارة | العداد
--------------|--------|------------|-------
2024-01-01    | 08:00  | دخول       | 1
2024-01-01    | 15:00  | خروج       | 1
2024-01-02    | 08:15  | دخول       | 2
2024-01-02    | 16:00  | خروج       | 2
...
2024-01-30    | 08:30  | دخول       | 30
```

**الاستفادة**:
- معرفة أن الطالب منتظم في الحضور
- تحديد أوقات الدخول والخروج المعتادة
- كشف أي تغيير في النمط (غياب، دخول متأخر)

### مثال 2: كشف نشاط مشبوه

**السيناريو**: مركبة غير مصرح لها تدخل عدة مرات

```
التاريخ        | الوقت  | العداد | التنبيه
--------------|--------|--------|--------
2024-01-15    | 09:00  | 1      | -
2024-01-15    | 11:00  | 2      | -
2024-01-15    | 13:00  | 3      | -
2024-01-15    | 15:00  | 4      | -
2024-01-15    | 17:00  | 5      | -
2024-01-15    | 19:00  | 6      | ⚠️ نشاط مشبوه!
```

**الإجراء**:
- إرسال تنبيه فوري للأمن الجامعي
- إضافة المركبة إلى قائمة المراقبة
- مراجعة صور الزيارات السابقة

### مثال 3: تحليل استخدام موقف السيارات

**السيناريو**: تحليل استخدام موقف أعضاء هيئة التدريس

```sql
SELECT 
  v.plateNumber,
  v.ownerName,
  v.visitCount,
  COUNT(DISTINCT DATE(vi.timestamp)) as days_visited
FROM vehicles v
JOIN visits vi ON v.id = vi.vehicleId
WHERE v.ownerType = 'faculty'
  AND vi.timestamp >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY v.id
ORDER BY v.visitCount DESC;
```

**النتيجة**:
```
رقم اللوحة | المالك      | إجمالي الزيارات | عدد الأيام
-----------|------------|----------------|----------
ABC 1234   | د. أحمد    | 60             | 30
XYZ 5678   | د. محمد    | 45             | 25
DEF 9012   | د. سعيد    | 20             | 15
```

**الاستفادة**:
- تحديد أعضاء هيئة التدريس الأكثر التزاماً
- تخطيط أفضل لمواقف السيارات
- تخصيص مواقف دائمة للأكثر تكراراً

---

## التكامل مع الميزات الأخرى

### 1. التكامل مع نظام المخالفات

```javascript
// عند تسجيل مخالفة، يتم فحص عداد التكرار
if (vehicle.visitCount > 50 && violation.type === 'speeding') {
  // مركبة متكررة + مخالفة سرعة = تشديد العقوبة
  violation.severity = 'high';
  violation.points += 2; // نقاط إضافية
}
```

### 2. التكامل مع نظام التاجات (Tags)

```javascript
// تلقائياً إضافة تاج VIP للمركبات الأكثر تكراراً
if (vehicle.visitCount >= 100) {
  assignTag(vehicle.id, 'VIP');
}

// تلقائياً إضافة تاج "مشبوه" للمركبات غير الطبيعية
if (vehicle.visitCount > 5 && isToday(vehicle.lastVisit)) {
  assignTag(vehicle.id, 'Suspicious');
}
```

### 3. التكامل مع التقارير

- **تقرير شهري**: عدد الزيارات لكل مركبة
- **تقرير سنوي**: إجمالي الزيارات حسب نوع المستخدم
- **تقرير مقارن**: مقارنة الزيارات بين الأشهر

---

## الإعدادات والتخصيص

### 1. حد التنبيه

يمكنك تخصيص حد التنبيه للمركبات المشبوهة:

```javascript
// في صفحة الإعدادات
const SUSPICIOUS_VISIT_THRESHOLD = 5; // عدد الزيارات في اليوم
const SUSPICIOUS_TIME_WINDOW = 24; // بالساعات
```

### 2. إعادة تعيين العداد

في حالات خاصة (بداية العام الدراسي، صيانة):

```sql
-- إعادة تعيين عداد جميع المركبات
UPDATE vehicles SET visitCount = 0;

-- إعادة تعيين عداد مركبة محددة
UPDATE vehicles SET visitCount = 0 WHERE plateNumber = 'ABC1234';
```

### 3. تصدير البيانات

يمكنك تصدير بيانات العداد:

- **Excel**: تقرير شامل بجميع المركبات وعدد زياراتها
- **PDF**: تقرير مطبوع للإدارة
- **CSV**: للتحليل في برامج أخرى

---

## الأسئلة الشائعة

### س1: هل يتم احتساب الخروج ضمن العداد؟

**ج**: نعم، كل من الدخول والخروج يتم احتسابهما. إذا كانت المركبة دخلت وخرجت في نفس اليوم، العداد يزيد مرتين (مرة للدخول ومرة للخروج).

### س2: ماذا لو كانت الكاميرا قرأت اللوحة بشكل خاطئ؟

**ج**: النظام يستخدم **نسبة الثقة (Confidence Score)** من Plate Recognizer. إذا كانت النسبة أقل من 80%، يتم وضع علامة تحذير ويمكن للمشرف مراجعتها يدوياً.

### س3: هل يمكن تعديل العداد يدوياً؟

**ج**: نعم، المشرف يمكنه تعديل العداد من صفحة "مركز البيانات" في حالة وجود خطأ أو حاجة للتصحيح.

### س4: كيف يتم التعامل مع المركبات الجديدة؟

**ج**: عند أول زيارة، يتم إنشاء سجل جديد للمركبة تلقائياً بعداد = 1، ويتم تصنيفها كـ "زائر" حتى يتم تحديث بياناتها.

### س5: هل العداد يعمل مع جميع أنواع اللوحات؟

**ج**: نعم، النظام يدعم:
- اللوحات السعودية (عربي وإنجليزي)
- اللوحات الخاصة (دبلوماسية، حكومية)
- اللوحات المؤقتة

---

## الخلاصة

**عداد التكرار التلقائي** هو أداة قوية لتتبع وتحليل حركة المركبات في الحرم الجامعي. من خلال التكامل مع Plate Recognizer API، يوفر النظام:

✅ **دقة عالية** في التعرف على اللوحات
✅ **تحديث تلقائي** بدون تدخل يدوي
✅ **تنبيهات ذكية** للأنماط المشبوهة
✅ **تقارير شاملة** لاتخاذ القرارات
✅ **تكامل كامل** مع جميع ميزات النظام

للاستفادة القصوى من هذه الميزة، تأكد من:
1. إدخال مفتاح Plate Recognizer API في صفحة الإعدادات
2. مراجعة تقرير التكرار بشكل دوري
3. إعداد التنبيهات المناسبة لاحتياجاتك
4. تحليل البيانات لتحسين الأمن والكفاءة

---

**تم إعداد هذا الدليل بواسطة**: فريق تطوير نظام إدارة المرور الجامعي
**التاريخ**: نوفمبر 2024
**الإصدار**: 1.0
